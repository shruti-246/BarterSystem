{% extends "base.html" %}
{% block title %}Propose Trade - BarterDB{% endblock %}
{% block content %}

<h1>Propose a Trade</h1>

<div class="container">
  <select id="offeredItem">
    <option value="">Select Your Item to Offer</option>
  </select>

  <select id="requestedItem">
    <option value="">Select Item You Want</option>
  </select>

  <button onclick="proposeTrade()">Propose Trade</button>
  <div class="back" onclick="goBack()">‚Üê Back to Dashboard</div>
</div>

<script>
const BACKEND_URL = "{{ request.host_url.rstrip('/') }}";
const proposerId = sessionStorage.getItem('user_id');

if (!proposerId) {
  alert('Please login first!');
  window.location.href = "{{ url_for('signup_login_view') }}";
}

async function loadItems() {
  try {
    const userId = parseInt(proposerId);
    const resMine = await fetch(`${BACKEND_URL}/my_items/${userId}`);
    const myItems = await resMine.json();

    const resAll = await fetch(`${BACKEND_URL}/items`);
    const allItems = await resAll.json();

    const offeredDropdown = document.getElementById('offeredItem');
    const requestedDropdown = document.getElementById('requestedItem');

    offeredDropdown.innerHTML = '<option value="">Select Your Item to Offer</option>';
    requestedDropdown.innerHTML = '<option value="">Select Item You Want</option>';

    // Add user's and partners' items to "offered"
    myItems.forEach(item => {
      const opt = document.createElement('option');
      const ownerLabel = item.owner_id === userId ? 'You' : `Partner: ${item.owner_username}`;
      opt.value = item.id;
      opt.textContent = `${item.name} (${item.condition}) - ${ownerLabel}`;
      offeredDropdown.appendChild(opt);
    });

    // Add all other items to "requested"
    allItems.forEach(item => {
      if (myItems.find(m => m.id === item.id)) return;
      const opt = document.createElement('option');
      opt.value = item.id;
      opt.textContent = `${item.name} (${item.condition}) - Owned by ${item.owner_username}`;
      requestedDropdown.appendChild(opt);
    });

  } catch (error) {
    alert('Failed to load items.');
  }
}

async function proposeTrade() {
  const offeredItemId = document.getElementById('offeredItem').value;
  const requestedItemId = document.getElementById('requestedItem').value;

  if (!offeredItemId || !requestedItemId) {
    alert('Please select both items.');
    return;
  }

  try {
    const res = await fetch(`${BACKEND_URL}/propose_trade`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        proposer_id: proposerId,
        offered_item_id: offeredItemId,
        requested_item_id: requestedItemId
      })
    });
    const data = await res.json();

    if (res.ok) {
      alert(`Trade proposed successfully!\nShare this code with the other user: ${data.acceptor_half}`);
      window.location.href = "{{ url_for('dashboard_view') }}";
    } else {
      alert(data.message || 'Failed to propose trade.');
    }
  } catch (error) {
    alert('Error proposing trade.');
  }
}

function goBack() {
  window.location.href = "{{ url_for('dashboard_view') }}";
}

loadItems();
</script>

{% endblock %}


