{% extends "base.html" %}
{% block title %}Admin Panel - BarterDB{% endblock %}
{% block content %}
<h1>Admin Panel</h1>

<div class="section">
  <h2>Users</h2>
  <div id="user-list"></div>
</div>

<div class="section">
  <h2>Items</h2>
  <div id="item-list"></div>
</div>

<div class="section">
  <h2>Partnerships</h2>
  <div id="partnership-list"></div>
</div>

<div class="section">
  <h2>Finalized Trades</h2>
  <div id="finalized-trades"></div>
</div>

<script>
const BACKEND_URL = "{{ request.host_url.rstrip('/') }}";

async function loadAdminData() {
  await loadUsers();
  await loadItems();
  await loadPartnerships();
  await loadFinalizedTrades();
}

if (!sessionStorage.getItem('is_admin')) {
  const adminPassword = prompt('Enter Admin Password:');
  if (adminPassword !== 'admin123') {
    alert('Incorrect password! Redirecting...');
    window.location.href = "{{ url_for('admin_login_view') }}";
  } else {
    sessionStorage.setItem('is_admin', 'true');
  }
}

async function loadUsers() {
  const res = await fetch(`${BACKEND_URL}/admin/users`);
  const users = await res.json();
  let html = '<table><tr><th>ID</th><th>Username</th><th>Email</th><th>Actions</th></tr>';
  users.forEach(user => {
    html += `<tr>
               <td>${user.id}</td>
               <td>${user.username}</td>
               <td>${user.email}</td>
               <td><button onclick="deleteUser(${user.id})">Delete</button></td>
             </tr>`;
  });
  html += '</table>';
  document.getElementById('user-list').innerHTML = html;
}

async function loadItems() {
  const res = await fetch(`${BACKEND_URL}/admin/items`);
  const items = await res.json();
  let html = '<table><tr><th>ID</th><th>Name</th><th>Owner</th><th>Actions</th></tr>';
  items.forEach(item => {
    html += `<tr>
               <td>${item.id}</td>
               <td>${item.name}</td>
               <td>${item.owner_username}</td>
               <td><button onclick="deleteItem(${item.id})">Delete</button></td>
             </tr>`;
  });
  html += '</table>';
  document.getElementById('item-list').innerHTML = html;
}

async function loadPartnerships() {
  const res = await fetch(`${BACKEND_URL}/admin/partnerships`);
  const partnerships = await res.json();
  let html = '<table><tr><th>ID</th><th>User</th><th>Partner</th><th>Actions</th></tr>';
  partnerships.forEach(p => {
    html += `<tr>
               <td>${p.id}</td>
               <td>${p.user}</td>
               <td>${p.partner}</td>
               <td><button onclick="deletePartnership(${p.id})">Delete</button></td>
             </tr>`;
  });
  html += '</table>';
  document.getElementById('partnership-list').innerHTML = html;
}

async function loadFinalizedTrades() {
  const res = await fetch(`${BACKEND_URL}/admin/finalized_trades`);
  const trades = await res.json();
  let html = '<table><tr><th>Trade ID</th><th>Code</th><th>Proposer</th></tr>';
  trades.forEach(trade => {
    html += `<tr>
               <td>${trade.trade_id}</td>
               <td>${trade.code}</td>
               <td>${trade.proposer_username}</td>
             </tr>`;
  });
  html += '</table>';
  document.getElementById('finalized-trades').innerHTML = html;
}

async function deleteUser(userId) {
  if (confirm('Are you sure you want to delete this user?')) {
    await fetch(`${BACKEND_URL}/admin/delete_user/${userId}`, { method: 'DELETE' });
    loadUsers();
  }
}

async function deleteItem(itemId) {
  if (confirm('Are you sure you want to delete this item?')) {
    await fetch(`${BACKEND_URL}/admin/delete_item/${itemId}`, { method: 'DELETE' });
    loadItems();
  }
}

async function deletePartnership(partnershipId) {
  if (confirm('Are you sure you want to cancel this partnership?')) {
    await fetch(`${BACKEND_URL}/admin/delete_partnership/${partnershipId}`, { method: 'DELETE' });
    loadPartnerships();
  }
}

loadAdminData();
</script>
{% endblock %}


