{% extends "base.html" %}
{% block title %}Manage Proposals - BarterDB{% endblock %}
{% block content %}

<h1>Manage Trade Proposals</h1>

<div class="proposal-list" id="proposal-list"></div>

<div class="back" onclick="goBack()">‚Üê Back to Dashboard</div>

<script>
const BACKEND_URL = "{{ request.host_url.rstrip('/') }}";
const myUserId = sessionStorage.getItem('user_id');

if (!myUserId) {
  alert('Please login first!');
  window.location.href = "{{ url_for('signup_login_view') }}";
}

async function loadProposals() {
  try {
    const resTrades = await fetch(`${BACKEND_URL}/trades`);
    const trades = await resTrades.json();
    const resItems = await fetch(`${BACKEND_URL}/items`);
    const items = await resItems.json();

    const itemMap = {};
    items.forEach(item => itemMap[item.id] = item);

    const myProposals = trades.filter(trade => {
      const requestedItem = itemMap[trade.requested_item_id];
      return requestedItem && requestedItem.owner_id == myUserId && trade.status === 'pending';
    });

    const container = document.getElementById('proposal-list');
    container.innerHTML = '';

    if (myProposals.length === 0) {
      container.innerHTML = '<p>No incoming proposals right now.</p>';
    } else {
      myProposals.forEach(proposal => {
        const offered = itemMap[proposal.offered_item_id];
        const requested = itemMap[proposal.requested_item_id];

        const div = document.createElement('div');
        div.className = 'proposal-card';
        div.innerHTML = `
          <strong>Offered:</strong> ${offered.name} (${offered.condition})<br>
          <strong>Requested:</strong> ${requested.name} (${requested.condition})<br>
          <button class="accept" onclick="acceptTrade(${proposal.id}, ${offered.id}, ${requested.id})">Accept</button>
          <button class="reject" onclick="rejectTrade(${proposal.id})">Reject</button>
        `;
        container.appendChild(div);
      });
    }
  } catch (error) {
    alert('Failed to load proposals.');
  }
}

async function acceptTrade(tradeId, offeredItemId, requestedItemId) {
  try {
    const enteredCode = prompt('Enter your half of the transaction code:');

    if (!enteredCode) {
      alert('Code is required to accept the trade.');
      return;
    }

    const codeRes = await fetch(`${BACKEND_URL}/submit_code`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        trade_id: tradeId,
        half_code: enteredCode.trim()
      })
    });

    const codeData = await codeRes.json();

    if (codeRes.ok) {
      alert(`Code accepted!\nOther half to complete the transaction: ${codeData.other_half}`);
      loadProposals();
    } else {
      alert(codeData.message || 'Invalid code.');
    }
  } catch (error) {
    alert('Error accepting trade.');
  }
}

async function rejectTrade(tradeId) {
  try {
    await fetch(`${BACKEND_URL}/delete_trade/${tradeId}`, { method: 'DELETE' });
    alert('Trade rejected and deleted.');
    loadProposals();
  } catch (error) {
    alert('Error rejecting trade.');
  }
}

function goBack() {
  window.location.href = "{{ url_for('dashboard_view') }}";
}

loadProposals();
</script>

{% endblock %}


