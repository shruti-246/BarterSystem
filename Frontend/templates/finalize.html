{% extends "base.html" %}
{% block title %}Finalize Trades - BarterDB{% endblock %}
{% block content %}

<h1>Finalize Completed Trades</h1>

<div class="trade-list" id="trade-list">
  <!-- Trade cards will go here -->
</div>

<script>
const BACKEND_URL = "{{ request.host_url.rstrip('/') }}";
const myUserId = sessionStorage.getItem('user_id');

if (!myUserId) {
  alert('Please login first!');
  window.location.href = "{{ url_for('signup_login_view') }}";
}

async function loadFinalizableTrades() {
  try {
    const resTrades = await fetch(`${BACKEND_URL}/trades`);
    const trades = await resTrades.json();

    const resItems = await fetch(`${BACKEND_URL}/items`);
    const items = await resItems.json();

    // Map items by ID
    const itemMap = {};
    items.forEach(item => itemMap[item.id] = item);

    const container = document.getElementById('trade-list');
    container.innerHTML = '';

    for (const trade of trades) {
      const offeredItem = itemMap[trade.offered_item_id];
      const requestedItem = itemMap[trade.requested_item_id];

      const isUserInvolved =
        trade.proposer_id == myUserId ||
        (requestedItem && requestedItem.owner_id == myUserId);

      if (!isUserInvolved || !offeredItem || !requestedItem) continue;

      const transRes = await fetch(`${BACKEND_URL}/get_transaction/${trade.id}`);
      const transaction = await transRes.json();

      const div = document.createElement('div');
      div.className = 'trade-card';
      div.innerHTML = `
        <p><strong>Offering:</strong> ${offeredItem.name}</p>
        <p><strong>Requesting:</strong> ${requestedItem.name}</p>
        <input type="text" id="code-${trade.id}" placeholder="Enter your half-code" />
        <button onclick="submitCode(${trade.id})">Submit Code</button>
        <button id="finalize-${trade.id}" onclick="finalizeTrade(${trade.id})" disabled>Finalize Trade</button>
        <p id="status-${trade.id}" class="status-text"></p>
      `;

      if (transaction.proposer_confirmed &&
          transaction.acceptor_confirmed &&
          !transaction.finalized) {
        div.querySelector(`#finalize-${trade.id}`).disabled = false;
        div.querySelector(`#status-${trade.id}`).textContent =
          'Both users confirmed. Ready to finalize.';
      }

      container.appendChild(div);
    }

    if (!container.innerHTML.trim()) {
      container.innerHTML = '<p>No trades found.</p>';
    }
  } catch (error) {
    alert('Failed to load trades.');
  }
}

async function submitCode(tradeId) {
  const codeInput = document.getElementById(`code-${tradeId}`);
  const statusText = document.getElementById(`status-${tradeId}`);
  const code = codeInput.value.trim();

  if (!code) {
    statusText.textContent = 'Please enter your half-code.';
    return;
  }

  try {
    const res = await fetch(`${BACKEND_URL}/submit_code`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trade_id: tradeId, half_code: code })
    });

    const data = await res.json();

    if (res.ok) {
      statusText.textContent = data.message + ' You may now finalize the trade.';
      document.getElementById(`finalize-${tradeId}`).disabled = false;
    } else {
      statusText.textContent = data.message;
    }
  } catch (error) {
    statusText.textContent = 'Error submitting code.';
  }
}

async function finalizeTrade(tradeId) {
  try {
    const res = await fetch(`${BACKEND_URL}/finalize_trade/${tradeId}`, {
      method: 'POST'
    });
    const data = await res.json();
    alert(data.message);
    loadFinalizableTrades();
  } catch (error) {
    alert('Failed to finalize trade.');
  }
}

loadFinalizableTrades();
</script>

{% endblock %}


